<p-toast></p-toast>
<p-confirmdialog></p-confirmdialog>

@if (studentLoading) {
  <p-card class="profile-card">
    <div class="skeleton-profile">
      <div class="skeleton-header">
        <p-skeleton shape="circle" size="56px"></p-skeleton>
        <div class="skeleton-text">e
          <p-skeleton width="200px" height="24px"></p-skeleton>
          <p-skeleton width="150px" height="16px" class="mt-1"></p-skeleton>
        </div>
      </div>
      <div class="skeleton-details">
        @for (i of [1,2,3,4,5,6]; track $index) {
          <p-skeleton width="100%" height="60px" borderRadius="8px"></p-skeleton>
        }
      </div>
    </div>
  </p-card>
}

@if (studentError && !studentLoading) {
  <p-card class="error-card">
    <div class="error-state">
      <i class="pi pi-exclamation-circle"></i>
      <h3>Eroare la încărcarea profilului</h3>
      <p>Nu s-au putut încărca datele studentului. Verifică conexiunea și încearcă din nou.</p>
      <p-button label="Reîncearcă" icon="pi pi-refresh" (onClick)="loadStudent()"></p-button>
    </div>
  </p-card>
}

@if (student && !studentLoading) {
  <p-card class="profile-card">
    <ng-template #header>
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="pi pi-user"></i>
        </div>
        <div class="profile-info">
          <h2>{{ student.fullName }}</h2>
          <p class="subtitle">{{ student.studyProgramme }}</p>
        </div>
        <p-button
          label="Ieșire"
          icon="pi pi-sign-out"
          severity="danger"
          [outlined]="true"
          class="ml-2"
          (onClick)="onLogout()">
        </p-button>
      </div>
    </ng-template>

    <div class="profile-details">
      <div class="detail-item">
        <i class="pi pi-building"></i>
        <div>
          <span class="detail-label">Facultate</span>
          <span class="detail-value">{{ student.faculty }}</span>
        </div>
      </div>
      <div class="detail-item">
        <i class="pi pi-calendar"></i>
        <div>
          <span class="detail-label">An de studiu</span>
          <span class="detail-value">{{ student.yearOfStudy }}</span>
        </div>
      </div>
      <div class="detail-item">
        <i class="pi pi-user-edit"></i>
        <div>
          <span class="detail-label">Tutore</span>
          <span class="detail-value">{{ student.hostTutor }}</span>
        </div>
      </div>
      <div class="detail-item">
        <i class="pi pi-briefcase"></i>
        <div>
          <span class="detail-label">Instituție Gazdă</span>
          <span class="detail-value">{{ student.hostInstitution }}</span>
        </div>
      </div>
      <div class="detail-item">
        <i class="pi pi-clock"></i>
        <div>
          <span class="detail-label">Perioada</span>
          <span class="detail-value">{{ student.internshipPeriod }}</span>
        </div>
      </div>
      <div class="detail-item">
        <i class="pi pi-id-card"></i>
        <div>
          <span class="detail-label">Director Practică</span>
          <span class="detail-value">{{ student.internshipDirector }}</span>
        </div>
      </div>
    </div>
  </p-card>
}

<div class="actions-bar">
  <p-button
    [label]="showForm ? 'Anulează' : 'Adaugă Activitate'"
    [icon]="showForm ? 'pi pi-times' : 'pi pi-plus'"
    [severity]="showForm ? 'secondary' : 'primary'"
    (onClick)="toggleForm()">
  </p-button>

  <p-button
    label="Export Word"
    icon="pi pi-file-word"
    severity="success"
    class="ml-2"
    (onClick)="exportToWord()">
  </p-button>

</div>

@if (showForm) {
  <p-card [header]="isEditing ? 'Editare Activitate' : 'Înregistrare Nouă'" class="form-card">
    <form [formGroup]="activityForm">

      <div class="form-row-3">
        <div class="field">
          <label for="dayNumber">Ziua *</label>
          <p-inputnumber id="dayNumber" formControlName="dayNumber" [min]="1" placeholder="ex: 1"
                         [style]="{'width': '100%'}"
                         [class]="isFieldInvalid('dayNumber') ? 'ng-invalid ng-dirty' : ''">
          </p-inputnumber>
          @if (isFieldInvalid('dayNumber')) {
            <small class="field-error">
              <i class="pi pi-exclamation-circle"></i> {{ getFieldError('dayNumber') }}
            </small>
          }
        </div>
        <div class="field">
          <label for="dateOfActivity">Data *</label>
          <p-datepicker id="dateOfActivity" formControlName="dateOfActivity" dateFormat="dd.mm.yy"
                        [showIcon]="true" placeholder="Selectează data" [style]="{'width': '100%'}"
                        [class]="isFieldInvalid('dateOfActivity') ? 'ng-invalid ng-dirty' : ''">
          </p-datepicker>
          @if (isFieldInvalid('dateOfActivity')) {
            <small class="field-error">
              <i class="pi pi-exclamation-circle"></i> {{ getFieldError('dateOfActivity') }}
            </small>
          }
        </div>
        <div class="field">
          <label>Interval Orar *</label>
          <div class="time-range">
            <p-datepicker formControlName="startTime" [timeOnly]="true" [showIcon]="true"
                          icon="pi pi-clock" placeholder="De la" [style]="{'width': '100%'}"
                          [class]="isFieldInvalid('startTime') ? 'ng-invalid ng-dirty' : ''">
            </p-datepicker>
            <span class="time-separator">—</span>
            <p-datepicker formControlName="endTime" [timeOnly]="true" [showIcon]="true"
                          icon="pi pi-clock" placeholder="Până la" [style]="{'width': '100%'}"
                          [class]="isFieldInvalid('endTime') ? 'ng-invalid ng-dirty' : ''">
            </p-datepicker>
          </div>
          @if (isFieldInvalid('startTime') || isFieldInvalid('endTime')) {
            <small class="field-error">
              <i class="pi pi-exclamation-circle"></i> Ambele ore sunt obligatorii
            </small>
          }
        </div>
      </div>

      <div class="field">
        <label for="venue">Locul Desfășurării *</label>
        <input pInputText id="venue" formControlName="venue" placeholder="ex: Departamentul IT"
               [ngClass]="{'ng-invalid ng-dirty': isFieldInvalid('venue')}" />
        @if (isFieldInvalid('venue')) {
          <small class="field-error">
            <i class="pi pi-exclamation-circle"></i> {{ getFieldError('venue') }}
          </small>
        }
      </div>

      <div class="field">
        <label for="activities">Activități Realizate *</label>
        <textarea pTextarea id="activities" formControlName="activities" rows="3"
                  placeholder="Descrieți activitățile realizate..."
                  [ngClass]="{'ng-invalid ng-dirty': isFieldInvalid('activities')}">
      </textarea>
        @if (isFieldInvalid('activities')) {
          <small class="field-error">
            <i class="pi pi-exclamation-circle"></i> {{ getFieldError('activities') }}
          </small>
        }
      </div>

      <div class="form-row-2">
        <div class="field">
          <label for="equipmentUsed">Echipamente Utilizate</label>
          <textarea pTextarea id="equipmentUsed" formControlName="equipmentUsed" rows="2"
                    placeholder="Laptop, VS Code..."></textarea>
        </div>
        <div class="field">
          <label for="practicedSkills">Competențe Exersate</label>
          <textarea pTextarea id="practicedSkills" formControlName="practicedSkills" rows="2"
                    placeholder="C#, baze de date..."></textarea>
        </div>
      </div>

      <div class="field">
        <label for="personalObservations">Observații Personale</label>
        <textarea pTextarea id="personalObservations" formControlName="personalObservations" rows="2"
                  placeholder="Observații, impresii..."></textarea>
      </div>

      <div class="form-actions">
        @if (isEditing) {
          <p-button
            label="Anulează editarea"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            (onClick)="toggleForm()"
            class="mr-2">
          </p-button>
        }
        <p-button
          [label]="saving ? 'Se salvează...' : (isEditing ? 'Actualizează' : 'Salvează în Jurnal')"
          [icon]="saving ? 'pi pi-spin pi-spinner' : (isEditing ? 'pi pi-pencil' : 'pi pi-check')"
          (onClick)="onSave()"
          [disabled]="!activityForm.valid || saving">
        </p-button>
      </div>
    </form>
  </p-card>
}

@if (activitiesLoading) {
  <p-card header="Activități Înregistrate" class="table-card">
    <div class="skeleton-table">
      <p-skeleton width="100%" height="40px" class="mb-2"></p-skeleton>
      @for (i of [1,2,3,4,5]; track $index) {
        <p-skeleton width="100%" height="50px" class="mb-1"></p-skeleton>
      }
    </div>
  </p-card>
}

@if (activitiesError && !activitiesLoading) {
  <p-card class="error-card">
    <div class="error-state">
      <i class="pi pi-exclamation-circle"></i>
      <h3>Eroare la încărcarea activităților</h3>
      <p>Nu s-au putut încărca activitățile. Verifică conexiunea și încearcă din nou.</p>
      <p-button label="Reîncearcă" icon="pi pi-refresh" (onClick)="loadActivities()"></p-button>
    </div>
  </p-card>
}

@if (!activitiesLoading && !activitiesError) {
  <p-card header="Activități Înregistrate" class="table-card">

    <div class="table-toolbar">
      <p-iconfield>
        <p-inputicon class="pi pi-search"></p-inputicon>
        <input pInputText type="text" placeholder="Caută activități..."
               class="search-input" (input)="onFilter($event)" />
      </p-iconfield>
    </div>

    <div class="desktop-table">
      <p-table #dt
               [value]="activities"
               [paginator]="true"
               [rows]="5"
               [rowsPerPageOptions]="[5, 10, 20]"
               [tableStyle]="{'min-width': '60rem'}"
               [globalFilterFields]="['venue', 'activities', 'equipmentUsed', 'practicedSkills', 'personalObservations']"
               sortField="dayNumber"
               [sortOrder]="1"
               class="p-datatable-striped">

        <ng-template #header>
          <tr>
            <th pSortableColumn="dayNumber" style="width: 80px">
              Ziua <p-sortIcon field="dayNumber"></p-sortIcon>
            </th>
            <th pSortableColumn="dateOfActivity" style="width: 120px">
              Data <p-sortIcon field="dateOfActivity"></p-sortIcon>
            </th>
            <th style="width: 120px">Interval</th>
            <th pSortableColumn="venue">
              Locație <p-sortIcon field="venue"></p-sortIcon>
            </th>
            <th>Activități</th>
            <th>Echipament</th>
            <th>Competențe</th>
            <th>Observații</th>
            <th style="width: 100px">Acțiuni</th>
          </tr>
        </ng-template>

        <ng-template #body let-activity>
          <tr>
            <td><span class="day-badge">{{ activity.dayNumber }}</span></td>
            <td>{{ activity.dateOfActivity | date:'dd.MM.yyyy' }}</td>
            <td>{{ activity.timeFrame }}</td>
            <td>{{ activity.venue }}</td>
            <td class="cell-wrap">{{ activity.activities }}</td>
            <td class="cell-wrap">{{ activity.equipmentUsed }}</td>
            <td class="cell-wrap">{{ activity.practicedSkills }}</td>
            <td class="cell-wrap">{{ activity.personalObservations }}</td>
            <td>
              <div class="action-buttons">
                <p-button icon="pi pi-pencil" severity="info" [rounded]="true" [text]="true"
                          (onClick)="onEdit(activity)" pTooltip="Editează"></p-button>
                <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true"
                          (onClick)="onDelete(activity)" pTooltip="Șterge"></p-button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="9" style="text-align: center; padding: 2rem;">
              <i class="pi pi-inbox" style="font-size: 2rem; color: #94a3b8;"></i>
              <p style="color: #64748b;">Nu există activități înregistrate încă.</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <div class="mobile-cards">
      @if (activities.length === 0) {
        <div class="empty-mobile">
          <i class="pi pi-inbox"></i>
          <p>Nu există activități înregistrate încă.</p>
        </div>
      }

      @for (activity of activities; track activity.id) {
        <div class="activity-card">
          <div class="card-top">
            <span class="day-badge">Ziua {{ activity.dayNumber }}</span>
            <span class="card-date">{{ activity.dateOfActivity | date:'dd.MM.yyyy' }}</span>
            <div class="card-actions">
              <p-button icon="pi pi-pencil" severity="info" [rounded]="true" [text]="true" size="small"
                        (onClick)="onEdit(activity)"></p-button>
              <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true" size="small"
                        (onClick)="onDelete(activity)"></p-button>
            </div>
          </div>
          <div class="card-body">
            <div class="card-row">
              <i class="pi pi-clock"></i>
              <span>{{ activity.timeFrame }}</span>
            </div>
            <div class="card-row">
              <i class="pi pi-map-marker"></i>
              <span>{{ activity.venue }}</span>
            </div>
            <div class="card-row">
              <i class="pi pi-list"></i>
              <span>{{ activity.activities }}</span>
            </div>
            @if (activity.equipmentUsed) {
              <div class="card-row">
                <i class="pi pi-wrench"></i>
                <span>{{ activity.equipmentUsed }}</span>
              </div>
            }
            @if (activity.practicedSkills) {
              <div class="card-row">
                <i class="pi pi-star"></i>
                <span>{{ activity.practicedSkills }}</span>
              </div>
            }
            @if (activity.personalObservations) {
              <div class="card-row">
                <i class="pi pi-comment"></i>
                <span>{{ activity.personalObservations }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </p-card>
}
